/obj/item/storage/mech
	w_class = WEIGHT_CLASS_BULKY
	var/use_sound = 'sound/mecha/mechstep.ogg'
	anchored = TRUE

/obj/item/mech_component/chassis/Adjacent(atom/neighbor, recurse = 1) //For interaction purposes we consider body to be adjacent to whatever holder mob is adjacent
	var/mob/living/exosuit/E = loc
	if(istype(E))
		. = E.Adjacent(neighbor, recurse)
	return . || ..()

/obj/item/storage/mech/Adjacent(atom/neighbor, recurse = 1) //in order to properly retrieve items
	var/obj/item/mech_component/chassis/C = loc
	if(istype(C))
		. = C.Adjacent(neighbor, recurse-1)
	return . || ..()

/obj/item/mech_component/chassis
	name = "body"
	icon_state = "loader_body"
	gender = NEUTER

	var/mech_health = 300
	var/obj/item/stock_parts/cell/cell
	var/obj/item/robot_parts/robot_component/diagnosis_unit/diagnostics
	var/obj/item/robot_parts/robot_component/armour/exosuit/m_armour
	var/obj/machinery/portable_atmospherics/canister/air_supply
	var/obj/item/storage/mech/storage_compartment
	var/datum/gas_mixture/cockpit
	var/transparent_cabin = FALSE
	var/hide_pilot =        FALSE
	var/hatch_descriptor = "cockpit"
	var/list/pilot_positions
	var/pilot_coverage = 100
	//var/min_pilot_size = MOB_SMALL
	//var/max_pilot_size = MOB_LARGE
	has_hardpoints = list(HARDPOINT_BACK, HARDPOINT_LEFT_SHOULDER, HARDPOINT_RIGHT_SHOULDER)
	var/damage_sound = 'sound/effects/bang.ogg'
	var/climb_time = 25
	var/air_supply_valve = ONE_ATMOSPHERE
	///Time to swap off the backmounted object
	var/spinal_delay = 2 SECONDS
/obj/item/mech_component/chassis/New()
	..()
	if(isnull(pilot_positions))
		pilot_positions = list(
			list(
				"[NORTH]" = list("x" = 8, "y" = 0),
				"[SOUTH]" = list("x" = 8, "y" = 0),
				"[EAST]"  = list("x" = 8, "y" = 0),
				"[WEST]"  = list("x" = 8, "y" = 0)
			)
		)

/obj/item/mech_component/chassis/Destroy()
	QDEL_NULL(cell)
	QDEL_NULL(diagnostics)
	QDEL_NULL(m_armour)
	QDEL_NULL(air_supply)
	QDEL_NULL(storage_compartment)
	. = ..()

/obj/item/mech_component/chassis/update_components()
	diagnostics = locate() in src
	cell =        locate() in src
	m_armour =    locate() in src
	air_supply =  locate() in src
	storage_compartment = locate() in src

/obj/item/mech_component/chassis/show_missing_parts(mob/user)
	if(!cell)
		to_chat(user, span_warning("It is missing a power cell."))
	if(!diagnostics)
		to_chat(user, span_warning("It is missing a diagnostics unit."))
	if(!m_armour)
		to_chat(user, span_warning("It is missing exosuit armour plating."))

/obj/item/mech_component/chassis/Initialize()
	. = ..()

	cockpit = new
	cockpit.set_temperature(T20C)
	cockpit.set_volume(200)
	cockpit.set_moles(GAS_O2, O2STANDARD*cockpit.return_volume()/(R_IDEAL_GAS_EQUATION*cockpit.return_temperature()))
	cockpit.set_moles(GAS_N2, N2STANDARD*cockpit.return_volume()/(R_IDEAL_GAS_EQUATION*cockpit.return_temperature()))
	if(pilot_coverage >= 100) //Open cockpits dont get to have air
		air_supply = new /obj/machinery/portable_atmospherics/canister/air(src)
	storage_compartment = new(src)

/obj/item/mech_component/chassis/proc/update_air()

	if(cockpit && cockpit.return_volume() > 0)
		var/delta = cockpit.return_temperature() - T20C
		cockpit.set_temperature(cockpit.return_temperature() - max(-10, min(10, round(delta/4,0.1))))

	if(air_supply)
		var/datum/gas_mixture/tank_air = air_supply.return_air()

		var/release_pressure = air_supply_valve
		var/cabin_pressure = cockpit.return_pressure()
		var/pressure_delta = min(release_pressure - cabin_pressure, (tank_air.return_pressure() - cabin_pressure)/2)
		var/transfer_moles = 0
		if(pressure_delta > 0) //cabin pressure lower than release pressure
			if(tank_air.return_temperature() > 0)
				transfer_moles = pressure_delta*cockpit.return_volume()/(cockpit.return_temperature() * R_IDEAL_GAS_EQUATION)
				tank_air.transfer_to(cockpit,transfer_moles)
		else if(pressure_delta < 0) //cabin pressure higher than release pressure
			var/datum/gas_mixture/t_air = return_air()
			pressure_delta = cabin_pressure - release_pressure
			if(t_air)
				pressure_delta = min(cabin_pressure - t_air.return_pressure(), pressure_delta)
			if(pressure_delta > 0) //if location pressure is lower than cabin pressure
				transfer_moles = pressure_delta*cockpit.return_volume()/(cockpit.return_temperature() * R_IDEAL_GAS_EQUATION)
				cockpit.transfer_to(t_air, transfer_moles)

	cockpit.react()

/obj/item/mech_component/chassis/ready_to_install()
	return (cell && diagnostics && m_armour)

/obj/item/mech_component/chassis/prebuild()
	diagnostics = new(src)
	cell = new /obj/item/stock_parts/cell/high(src)
	cell.charge = cell.maxcharge

/obj/item/mech_component/chassis/attackby(obj/item/thing, mob/living/user, list/click_params)
	if(istype(thing,/obj/item/robot_parts/robot_component/diagnosis_unit))
		if(diagnostics)
			to_chat(user, span_warning("\The [src] already has a diagnostic system installed."))
			return TRUE
		if(install_component(thing, user))
			diagnostics = thing
			return TRUE

	else if(istype(thing, /obj/item/stock_parts/cell))
		if(cell)
			to_chat(user, span_warning("\The [src] already has a cell installed."))
			return TRUE
		if(install_component(thing,user))
			cell = thing
			return TRUE

	else if(istype(thing, /obj/item/robot_parts/robot_component/armour/exosuit))
		if(m_armour)
			to_chat(user, span_warning("\The [src] already has armour installed."))
			return TRUE
		if(install_component(thing, user))
			m_armour = thing
			return TRUE

	return ..()

/obj/item/mech_component/chassis/MouseDrop_T(atom/dropping, mob/user)
	var/obj/machinery/portable_atmospherics/canister/C = dropping
	if(!istype(C))
		return ..()
	if(pilot_coverage < 100)
		to_chat(user, span_notice("This type of chassis doesn't support internals."))
	if(!C.anchored && do_after(user, 0.5 SECONDS, src))
		if(C.anchored)
			return
		to_chat(user, span_notice("You install the canister in the [src]."))
		if(air_supply)
			air_supply.forceMove(get_turf(src))
			air_supply = null
		C.forceMove(src)
		update_components()
	else . = ..()

/obj/item/mech_component/chassis/MouseDrop(atom/over)
	if(!usr || !over) return
	if(!Adjacent(usr) || !over.Adjacent(usr)) return

	if(storage_compartment)
		return storage_compartment.MouseDrop(over)

/obj/item/mech_component/chassis/return_diagnostics(mob/user)
	..()
	if(diagnostics)
		to_chat(user, span_notice(" Diagnostics Unit Integrity: <b>[round((((diagnostics.max_dam - diagnostics.total_dam) / diagnostics.max_dam)) * 100)]%</b>"))
	else
		to_chat(user, span_warning(" Diagnostics Unit Missing or Non-functional."))
	if(m_armour)
		to_chat(user, span_notice(" Armor Integrity: <b>[round((((m_armour.max_dam - m_armour.total_dam) / m_armour.max_dam)) * 100)]%</b>"))
	else
		to_chat(user, span_warning(" Armor Missing or Non-functional."))


/obj/item/mech_component/chassis/powerloader
	name = "open exosuit chassis"
	hatch_descriptor = "roll cage"
	pilot_coverage = 80
	exosuit_desc_string = "an industrial rollcage"
	desc = "A Xion industrial brand roll cage. Technically OSHA compliant. Technically."
	max_damage = 300
	swap_speed = 0 SECONDS
	power_use = 0
	climb_time = 6
	spinal_delay = 0.1 SECONDS

/obj/item/mech_component/chassis/powerloader/prebuild()
	. = ..()
	m_armour = new /obj/item/robot_parts/robot_component/armour/exosuit(src)

/obj/item/mech_component/chassis/powerloader/Initialize()
	pilot_positions = list(
		list(
			"[NORTH]" = list("x" = 8,  "y" = 8),
			"[SOUTH]" = list("x" = 8,  "y" = 8),
			"[EAST]"  = list("x" = 8,  "y" = 8),
			"[WEST]"  = list("x" = 8,  "y" = 8)
		),
		list(
			"[NORTH]" = list("x" = 8,  "y" = 16),
			"[SOUTH]" = list("x" = 8,  "y" = 16),
			"[EAST]"  = list("x" = 0,  "y" = 16),
			"[WEST]"  = list("x" = 16, "y" = 16)
		)
	)
	. = ..()

/obj/item/mech_component/chassis/light
	name = "light exosuit chassis"
	hatch_descriptor = "canopy"
	pilot_coverage = 100
	transparent_cabin =  TRUE
	exosuit_desc_string = "an open and light chassis"
	icon_state = "light_body"
	max_damage = 200
	power_use = 1
	has_hardpoints = list(HARDPOINT_BACK, HARDPOINT_LEFT_SHOULDER)
	damage_sound = 'sound/mecha/mechstep.ogg'
	desc = "The Veymed Odysseus series cockpits combine ultralight materials and clear aluminum laminates to provide an optimized cockpit experience."
	climb_time = 15
	swap_speed = 0 SECONDS
	spinal_delay = 0 SECONDS

/obj/item/mech_component/chassis/light/prebuild()
	. = ..()
	m_armour = new /obj/item/robot_parts/robot_component/armour/exosuit/radproof(src)

/obj/item/mech_component/chassis/light/Initialize()
	pilot_positions = list(
		list(
			"[NORTH]" = list("x" = 8,  "y" = 0),
			"[SOUTH]" = list("x" = 8,  "y" = 0),
			"[EAST]"  = list("x" = 3,  "y" = 0),
			"[WEST]"  = list("x" = 13, "y" = 0)
		)
	)
	. = ..()

/obj/item/mech_component/chassis/pod
	name = "spherical exosuit chassis"
	hatch_descriptor = "hatch"
	pilot_coverage = 100
	transparent_cabin = TRUE
	exosuit_desc_string = "a spherical chassis"
	icon_state = "pod_body"
	max_damage = 240
	power_use = 3
	has_hardpoints = list(HARDPOINT_BACK)
	desc = "The NanoTrasen Katamari series cockpits have won a massive tender by SCG few years back. No one is sure why, but these terrible things keep popping up on every government facility."
	spinal_delay = 0 SECONDS

/obj/item/mech_component/chassis/pod/Initialize()
	pilot_positions = list(
		list(
			"[NORTH]" = list("x" = 8,  "y" = 4),
			"[SOUTH]" = list("x" = 8,  "y" = 4),
			"[EAST]"  = list("x" = 12,  "y" = 4),
			"[WEST]"  = list("x" = 4,  "y" = 4)
		),
		list(
			"[NORTH]" = list("x" = 8,  "y" = 8),
			"[SOUTH]" = list("x" = 8,  "y" = 8),
			"[EAST]"  = list("x" = 10,  "y" = 8),
			"[WEST]"  = list("x" = 6, "y" = 8)
		)
	)
	. = ..()

/obj/item/mech_component/chassis/pod/prebuild()
	. = ..()
	m_armour = new /obj/item/robot_parts/robot_component/armour/exosuit/radproof(src)

/obj/item/mech_component/chassis/pod/Initialize()
	pilot_positions = list(
		list(
			"[NORTH]" = list("x" = 8,  "y" = 3),
			"[SOUTH]" = list("x" = 8,  "y" = 2),
			"[EAST]"  = list("x" = 4,  "y" = 3),
			"[WEST]"  = list("x" = 12, "y" = 3)
		)
	)
	. = ..()

/obj/item/mech_component/chassis/heavy
	name = "reinforced exosuit chassis"
	hatch_descriptor = "hatch"
	desc = "The HI-Koloss chassis is a veritable juggernaut, capable of protecting a pilot even in the most hostile of environments. It handles like a battlecruiser, however."
	pilot_coverage = 100
	exosuit_desc_string = "a heavily armoured chassis"
	icon_state = "heavy_body"
	max_damage = 650
	mech_health = 500
	power_use = 5
	has_hardpoints = list(HARDPOINT_BACK)
	spinal_delay = 3.5 SECONDS
	swap_speed = 2 SECONDS

/obj/item/mech_component/chassis/heavy/prebuild()
	pilot_positions = list(
		list(
			"[NORTH]" = list("x" = 8,  "y" = 8),
			"[SOUTH]" = list("x" = 9,  "y" = 2),
			"[EAST]"  = list("x" = 4,  "y" = 8),
			"[WEST]"  = list("x" = 12, "y" = 8)
		)
	)

	. = ..()

/obj/item/mech_component/chassis/heavy/prebuild()
	. = ..()
	m_armour = new /obj/item/robot_parts/robot_component/armour/exosuit/combat(src)

/obj/item/mech_component/chassis/combat
	name = "sealed exosuit chassis"
	hatch_descriptor = "canopy"
	pilot_coverage = 100
	exosuit_desc_string = "an armoured chassis"
	icon_state = "combat_body"
	power_use = 4
	max_damage = 400
	spinal_delay = 2 SECONDS
	swap_speed = 1.5 SECONDS

/obj/item/mech_component/chassis/combat/prebuild()
	. = ..()
	m_armour = new /obj/item/robot_parts/robot_component/armour/exosuit/combat(src)

/obj/item/mech_component/chassis/combat/Initialize()
	pilot_positions = list(
		list(
			"[NORTH]" = list("x" = 8,  "y" = 8),
			"[SOUTH]" = list("x" = 8,  "y" = 8),
			"[EAST]"  = list("x" = 4,  "y" = 8),
			"[WEST]"  = list("x" = 12, "y" = 8)
		)
	)

	. = ..()
