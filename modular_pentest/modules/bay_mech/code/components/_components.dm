/obj/item/mech_component
	icon = 'modular_pentest/modules/bay_mech/icons/mech_parts_held.dmi'
	w_class = WEIGHT_CLASS_HUGE
	gender = PLURAL
	color = COLOR_GRAY

	var/on_mech_icon = 'modular_pentest/modules/bay_mech/icons/mech_parts.dmi'
	var/exosuit_desc_string
	var/total_damage = 0
	var/brute_damage = 0
	var/burn_damage = 0
	var/max_damage = 60
	var/damage_state = 1
	var/list/has_hardpoints = list()
	var/decal
	var/power_use = 0
	///how long it takes to swap from an equipment
	var/swap_speed = 2 SECONDS
	dir = SOUTH

/obj/item/mech_component/set_color(new_colour)
	color = new_colour
	return color

/obj/item/mech_component/emp_act(severity)
	take_burn_damage(rand((10 - (severity*3)),15-(severity*4)))
	for(var/obj/item/thing in contents)
		thing.emp_act(severity)
	..()

/obj/item/mech_component/examine(mob/user)
	. = ..()
	if(ready_to_install())
		to_chat(user, span_notice("It is ready for installation."))
	else
		show_missing_parts(user)

//These icons have multiple directions but before they're attached we only want south.
/obj/item/mech_component/setDir()
	..(SOUTH)

/obj/item/mech_component/proc/show_missing_parts(mob/user)
	return

/obj/item/mech_component/proc/prebuild()
	return

/obj/item/mech_component/proc/install_component(obj/item/thing, mob/user)
	to_chat(user, span_notice("\The [user] installs \the [thing] in \the [src]."))
	if(user.transferItemToLoc(thing, src))
		return 1

/obj/item/mech_component/proc/update_health()
	total_damage = brute_damage + burn_damage
	if(total_damage > max_damage) total_damage = max_damage
	damage_state = floor(total_damage/max_damage * (MECH_COMPONENT_DAMAGE_DAMAGED_TOTAL) + MECH_COMPONENT_DAMAGE_UNDAMAGED)
	if((total_damage-max_damage)>=0)
		damage_state = MECH_COMPONENT_DAMAGE_DESTORYED

/obj/item/mech_component/proc/ready_to_install()
	return 1

/obj/item/mech_component/proc/repair_brute_damage(amt)
	take_brute_damage(-amt)

/obj/item/mech_component/proc/repair_burn_damage(amt)
	take_burn_damage(-amt)

/obj/item/mech_component/proc/take_brute_damage(amt)
	brute_damage = max(0, brute_damage + amt)
	update_health()
	if(damage_state == MECH_COMPONENT_DAMAGE_DAMAGED)
		take_component_damage(amt,0)

/obj/item/mech_component/proc/take_burn_damage(amt)
	burn_damage = max(0, burn_damage + amt)
	update_health()
	if(total_damage == max_damage)
		take_component_damage(0,amt)

/obj/item/mech_component/proc/take_component_damage(brute, burn)
	var/list/damageable_components = list()
	for(var/obj/item/robot_parts/robot_component/RC in contents)
		damageable_components += RC
	if(!length(damageable_components)) return
	var/obj/item/robot_parts/robot_component/RC = pick(damageable_components)
	if(RC.take_damage(brute, burn))
		qdel(RC)
		update_components()

/obj/item/mech_component/attackby(obj/item/thing, mob/living/user, list/click_params)
	if (thing.tool_behaviour == TOOL_SCREWDRIVER)
		if(length(contents))
			//Filter non movables
			var/list/valid_contents = list()
			for(var/atom/movable/A in contents)
				if(!A.anchored)
					valid_contents += A
			if(!length(valid_contents))
				return TRUE
			var/obj/item/removed = pick(valid_contents)
			if(!(removed in contents))
				return TRUE
			user.visible_message(span_notice("\The [user] removes \the [removed] from \the [src]."))
			removed.forceMove(user.loc)
			playsound(user.loc, 'sound/effects/pop.ogg', 50, 0)
			update_components()
		else
			to_chat(user, span_warning("There is nothing to remove."))
		return TRUE

	if (thing.tool_behaviour == TOOL_WELDER)
		repair_brute_generic(thing, user)
		return TRUE

	if (istype(thing,/obj/item/stack/cable_coil))
		repair_burn_generic(thing, user)
		return TRUE


	return ..()

/obj/item/mech_component/proc/update_components()
	return

/obj/item/mech_component/proc/repair_brute_generic(obj/item/weldingtool/WT, mob/user)
	if(!istype(WT))
		return
	if(!brute_damage)
		to_chat(user, span_notice("You inspect \the [src] but find nothing to weld."))
		return
	if(!WT.isOn())
		to_chat(user, span_notice("Turn \the [WT] on, first."))
		return

	user.visible_message(
		span_notice("The [user] begins welding the damage on the [src]..."),
		span_notice("You begin welding the damage on the [src]...")
	)
	var/repair_value = 30
	if(do_after(user, 1 SECONDS))
		repair_brute_damage(repair_value)
		to_chat(user, span_notice("You mend the damage to \the [src]."))
		playsound(user.loc, 'sound/items/Welder.ogg', 25, 1)

/obj/item/mech_component/proc/repair_burn_generic(obj/item/stack/cable_coil/CC, mob/user)
	if(!istype(CC))
		return
	if(!burn_damage)
		to_chat(user, span_notice("\The [src]'s wiring doesn't need replacing."))
		return

	var/needed_amount = 3
	if(CC.get_amount() < needed_amount)
		to_chat(user, span_notice("You need at least [needed_amount] unit\s of cable to repair this section."))
		return

	user.visible_message("\The [user] begins replacing the wiring of \the [src]...")

	if(do_after(user, 1 SECONDS, src))
		if(QDELETED(CC) || QDELETED(src) || !CC.use(needed_amount))
			return

		repair_burn_damage(25)
		to_chat(user, span_notice("You mend the damage to \the [src]'s wiring."))
		playsound(user.loc, 'sound/items/Deconstruct.ogg', 25, 1)
	return

/obj/item/mech_component/proc/get_damage_string()
	switch(damage_state)
		if(MECH_COMPONENT_DAMAGE_UNDAMAGED)
			return span_green("undamaged")
		if(MECH_COMPONENT_DAMAGE_DAMAGED)
			return span_yellowteamradio("damaged")
		if(MECH_COMPONENT_DAMAGE_DAMAGED_BAD)
			return span_purple("badly damaged")
		if(MECH_COMPONENT_DAMAGE_DAMAGED_TOTAL)
			return span_red("almost destroyed")
	return span_red("destroyed")

/obj/item/mech_component/proc/return_diagnostics(mob/user)
	to_chat(user, span_notice("[capitalize(src.name)]:"))
	to_chat(user, span_notice(" - Integrity: <b>[round((((max_damage - total_damage) / max_damage)) * 100)]%</b>" ))
